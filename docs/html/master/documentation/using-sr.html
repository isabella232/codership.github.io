<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <meta content="Using Streaming Replication" name="title" />
<meta content="en-US" name="language" />
<meta content="galera cluster, streaming replication" name="keywords" />
<meta content="Codership Oy, 2014 - 2019. All Rights Reserved." name="copyright" />

    <title>Using Streaming Replication &#8212; Galera Cluster Documentation</title>
    
    <link rel="stylesheet" href="../_static/reset-style.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../',
        VERSION:     '',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true,
        SOURCELINK_SUFFIX: '.txt'
      };
    </script>
    <script type="text/javascript" src="../_static/jquery.js"></script>
    <script type="text/javascript" src="../_static/underscore.js"></script>
    <script type="text/javascript" src="../_static/doctools.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Galera Arbitrator" href="arbitrator.html" />
    <link rel="prev" title="Auto-Eviction" href="auto-eviction.html" />


<script type="text/javascript" src="https://www.google.com/jsapi"></script>

<link rel="stylesheet" href="/library/_static/basic-style.css">
<link rel="stylesheet" href="/library/_static/header.css">
<link rel="stylesheet" href="/library/_static/footer.css">
<link rel="stylesheet" href="/library/_static/codership.css">

<link rel="alternate" type="application/rss+xml" title="Galera Cluster for MySQL &raquo; Feed" href="https://galeracluster.com/feed/" />
<link rel="alternate" type="application/rss+xml" title="Galera Cluster for MySQL &raquo; Comments Feed" href="https://galeracluster.com/comments/feed/" />
<link rel="alternate" type="application/rss+xml" title="Galera Cluster for MySQL &raquo; Support Comments Feed" href="https://galeracluster.com/support/feed/" />

<script type='text/javascript' src='https://galeracluster.com/wp-includes/js/comment-reply.min.js?ver=3.8.3'></script>

<link rel="EditURI" type="application/rsd+xml" title="RSD" href="https://galeracluster.com/xmlrpc.php?rsd" />
<link rel="wlwmanifest" type="application/wlwmanifest+xml" href="https://galeracluster.com/wp-includes/wlwmanifest.xml" />
<link rel='prev' title='Downloads' href='https://galeracluster.com/downloads/' />
<link rel='next' title='Community' href='https://galeracluster.com/community/' />
<meta name="generator" content="WordPress 3.8.3" />

<link rel='shortlink' href='https://galeracluster.com/?p=12' />

<style type="text/css">.recentcomments a{display:inline !important;padding:0 !important;margin:0 !important;}</style>
<style type="text/css" id="twentythirteen-header-css">
			.site-title,
			.site-description {
				position: absolute;
				clip: rect(1px 1px 1px 1px); /* IE7 */
				clip: rect(1px, 1px, 1px, 1px);
			}
				.site-header .home-link {
				min-height: 0;
			}
</style>

<script type="text/javascript">

		  var _gaq = _gaq || [];
		  _gaq.push(['_setAccount', 'UA-35163478-6']);
		  _gaq.push(['_trackPageview']);

		  (function() {
			var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
			ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'https://www') + '.google-analytics.com/ga.js';
			var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
		  })();

</script>

  </head>
  <body role="document">
	<div id="fb-root"></div>
	<script>(function(d, s, id) {
		  var js, fjs = d.getElementsByTagName(s)[0];
		  if (d.getElementById(id)) return;
		  js = d.createElement(s); js.id = id;
		  js.src = "//connect.facebook.net/en_US/all.js#xfbml=1";
		  fjs.parentNode.insertBefore(js, fjs);
		}(document, 'script', 'facebook-jssdk'));
	</script>

	<div id="page" class="hfeed site">

	<header id="masthead" class="site-header" role="banner">

	<div class="top">
	<a class="home-link" href="https://galeracluster.com/" title="Galera Cluster for MySQL" rel="home">
	<h1 class="site-title">Galera Cluster for MySQL</h1>
	<h2 class="site-description">The world&#039;s most advanced open source database cluster</h2>
	</a>
	</div>


	<div id="navbar" class="navbar">
	<nav id="site-navigation" class="navigation main-navigation" role="navigation">
	<div class="menu-main-menu-container">

	<ul id="menu-main-menu" class="nav-menu">
	<li id="menu-item-359" class="link-home menu-item menu-item-type-post_type menu-item-object-page menu-item-359"><a href="https://galeracluster.com/">Home</a></li>
	<li id="menu-item-35" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-has-children menu-item-35"><a href="https://galeracluster.com/products/">Products</a></li>
	<li id="menu-item-34" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-has-children menu-item-34"><a href="https://galeracluster.com/downloads/">Downloads</a></li>
	<li id="menu-item-33" class="menu-item menu-item-type-post_type menu-item-object-page current-menu-item page_item page-item-12 current_page_item current-menu-ancestor current-menu-parent current_page_parent current_page_ancestor menu-item-has-children menu-item-33"><a href="https://galeracluster.com/support/">Support</a></li>
	<li id="menu-item-32" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-has-children menu-item-32"><a href="https://galeracluster.com/community/">Community</a></li>
	<li id="menu-item-31" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-has-children menu-item-31"><a href="https://galeracluster.com/company/">Company</a></li>
	<li id="menu-item-297" class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-297"><a href="https://galeracluster.com/category/blog/">Blog</a></li>
	<li id="menu-item-38" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-38"><a href="https://galeracluster.com/contact-us/">Contact us</a></li>
	</ul>
	</div>


	</nav><!-- #site-navigation -->

	</div><!-- #navbar -->
	</header><!-- #masthead -->


  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <div class="left-margin container">
<div class="left-margin-top container">
<a class="reference internal" href="../index.html"><span class="doc">The Library</span></a></div>
<div class="left-margin-content container">
<ul class="here simple">
<li><a class="reference internal" href="index.html"><span class="doc">Documentation</span></a></li>
</ul>
<ul class="simple">
<li><a class="reference internal" href="../kb/index.html"><span class="doc">Knowledge Base</span></a></li>
<li><a class="reference internal" href="../training/index.html"><span class="doc">Training</span></a></li>
</ul>
<ul class="sub-links simple">
<li><a class="reference internal" href="../training/tutorials/index.html"><span class="doc">Tutorial Articles</span></a></li>
<li><a class="reference internal" href="../training/videos/index.html"><span class="doc">Training Videos</span></a></li>
</ul>
<ul class="simple">
<li><a class="reference internal" href="../faq.html"><span class="doc">FAQ</span></a></li>
</ul>
<p>Related Documents</p>
<ul class="simple">
<li><a class="reference internal" href="streaming-replication.html#when-use-sr"><span class="std std-ref">When to Stream</span></a></li>
<li><a class="reference internal" href="mysql-wsrep-options.html#wsrep-trx-fragment-unit"><span class="std std-ref">wsrep_trx_fragment_unit</span></a></li>
<li><a class="reference internal" href="mysql-wsrep-options.html#wsrep-trx-fragment-size"><span class="std std-ref">wsrep_trx_fragment_size</span></a></li>
</ul>
<p>Related Articles</p>
</div>
</div>
<div class="library-document section" id="using-streaming-replication">
<span id="using-sr"></span><h1>Using Streaming Replication<a class="headerlink" href="#using-streaming-replication" title="Permalink to this headline">Â¶</a></h1>
<p id="index-0">When a node replicates a transaction under <a class="reference internal" href="glossary.html#term-streaming-replication"><span class="xref std std-term">Streaming Replication</span></a>, it breaks the transaction into fragments, and then certifies and applies the fragments to slave nodes while the transaction is still in progress.</p>
<p>This allows you to work with larger data-sets, manage hot records, and help avoid conflicts and hangs in the case of long-running transactions.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Streaming Replication is a new feature introduced in version 4.0 of Galera Cluster.  Older versions do not support these operations.</p>
</div>
<p class="section-heading rubric" id="enable-sr">Enabling Streaming Replication</p>
<p>The best practice when working with <a class="reference internal" href="glossary.html#term-streaming-replication"><span class="xref std std-term">Streaming Replication</span></a> is to enable it at a session-level for specific transactions, or parts thereof.  The reason is that Streaming Replication increases the load on all nodes when applying and rolling back transactions.  You&#8217;ll get better performance if you only enable Streaming Replication on those transactions that won&#8217;t run correctly without it.</p>
<p>For more information, see <a class="reference internal" href="streaming-replication.html#when-use-sr"><span class="std std-ref">When to Use Streaming Replication</span></a>.</p>
<p>Enabling Streaming Replication requires you to define the replication unit and number of units to use in forming the transaction fragments.  Two parameters control these variables: <a class="reference internal" href="mysql-wsrep-options.html#wsrep-trx-fragment-unit"><span class="std std-ref">wsrep_trx_fragment_unit</span></a> and <a class="reference internal" href="mysql-wsrep-options.html#wsrep-trx-fragment-size"><span class="std std-ref">wsrep_trx_fragment_size</span></a>.</p>
<p>Below is an example of how to set these two parameters:</p>
<div class="highlight-mysql"><div class="highlight"><pre><span></span><span class="kt">SET</span> <span class="n">SESSION</span> <span class="n">wsrep_trx_fragment_unit</span><span class="o">=</span><span class="s1">&#39;statements&#39;</span><span class="p">;</span>
<span class="kt">SET</span> <span class="n">SESSION</span> <span class="n">wsrep_trx_fragment_size</span><span class="o">=</span><span class="mi">3</span><span class="p">;</span>
</pre></div>
</div>
<p>In this example, the fragment is set to three statements.  For every three statements from a transaction, the node will generate, replicate and certify a fragment.</p>
<p>You can choose between a few replication units when forming fragments:</p>
<ul class="simple">
<li><strong>bytes</strong> This defines the fragment size in bytes.</li>
<li><strong>rows</strong> This defines the fragment size as the number of rows the fragment updates.</li>
<li><strong>statements</strong> This defines the fragment size as the number of statements in a fragment.</li>
</ul>
<p>Choose the replication unit and fragment size that best suits the specific operation you want to run.</p>
<p class="section-heading rubric" id="usr-hot-records">Streaming Replication with Hot Records</p>
<p>When your application needs to update frequently the same records from the same table (e.g., implementing a locking scheme, a counter, or a job queue), Streaming Replication allows you to force critical changes to replicate to the entire cluster.</p>
<p>For instance, consider the use case of a web application that creates work orders for a company.  When the transaction starts, it updates the table <code class="docutils literal"><span class="pre">work_orders</span></code>, setting the queue position for the order.  Under normal replication, two transactions can come into conflict if they attempt to update the queue position at the same time.</p>
<p>You can avoid this with Streaming Replication.  As an example of how to do this, you would first execute the following SQL statement to begin the transaction:</p>
<blockquote>
<div><div class="highlight-mysql"><div class="highlight"><pre><span></span><span class="n">START</span> <span class="n">TRANSACTION</span><span class="p">;</span>
</pre></div>
</div>
</div></blockquote>
<p>After reading the data that you need for the application, you would enable Streaming Replication by executing the following two <code class="docutils literal"><span class="pre">SET</span></code> statements:</p>
<blockquote>
<div><div class="highlight-mysql"><div class="highlight"><pre><span></span><span class="kt">SET</span> <span class="n">SESSION</span> <span class="n">wsrep_trx_fragment_unit</span><span class="o">=</span><span class="s1">&#39;statements&#39;</span><span class="p">;</span>
<span class="kt">SET</span> <span class="n">SESSION</span> <span class="n">wsrep_trx_fragment_size</span><span class="o">=</span><span class="mi">1</span><span class="p">;</span>
</pre></div>
</div>
</div></blockquote>
<p>Next, set the user&#8217;s position in the queue like so:</p>
<blockquote>
<div><div class="highlight-mysql"><div class="highlight"><pre><span></span><span class="k">UPDATE</span> <span class="n">work_orders</span>
<span class="kt">SET</span> <span class="n">queue_position</span> <span class="o">=</span> <span class="n">queue_position</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
</pre></div>
</div>
</div></blockquote>
<p>With that done, you can disable Streaming Replication by executing one of the previous <code class="docutils literal"><span class="pre">SET</span></code> statements, but with a different value like so:</p>
<blockquote>
<div><div class="highlight-mysql"><div class="highlight"><pre><span></span><span class="kt">SET</span> <span class="n">SESSION</span> <span class="n">wsrep_trx_fragment_size</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>
</pre></div>
</div>
</div></blockquote>
<p>You can now perform whatever additional tasks you need to prepare the work order, and then commit the transaction:</p>
<blockquote>
<div><div class="highlight-mysql"><div class="highlight"><pre><span></span><span class="n">COMMIT</span><span class="p">;</span>
</pre></div>
</div>
</div></blockquote>
<p>During the work order transaction, the client initiates Streaming Replication for a single statement, which it uses to set the queue position.  The queue position update then replicates throughout the cluster, which prevents other nodes from coming into conflict with the new work order.</p>
</div>


          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
            <p class="logo"><a href="../index.html">
              <img class="logo" src="../_static/logo.png" alt="Logo"/>
            </a></p><div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../index.html">Documentation overview</a><ul>
  <li><a href="index.html">The Codership Documentation</a><ul>
  <li><a href="administration.html">Galera Cluster Administration</a><ul>
      <li>Previous: <a href="auto-eviction.html" title="previous chapter">Auto-Eviction</a></li>
      <li>Next: <a href="arbitrator.html" title="next chapter">Galera Arbitrator</a></li>
  </ul></li>
  </ul></li>
  </ul></li>
</ul>
</div>
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <form class="search" action="../search.html" method="get">
      <div><input type="text" name="q" /></div>
      <div><input type="submit" value="Go" /></div>
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
	<div class="navbar">
	<nav id="site-navigation" class="navigation main-navigation" role="navigation">
	<div class="nav-bar-container">

	<div id="menu-nav-bar" class="nav-menu">
		<ul class="nav-link">
			<li> </li>

		</ul>

	</div>
	</nav>

	<footer id="colophon" class="site-footer" role="contentinfo">
	<div class="top">	<div class="powered-by"><p>Powered by Galera:</p>
	<p><a href="https://mariadb.com/kb/en/galera/"><img class="alignleft size-full wp-image-237" alt="MariaDB" src="https://galeracluster.com/wp-content/uploads/2013/10/logo-mariadb.png" width="166" height="49" /></a></p>
		</div></div>
	<div class="footer-menu">
	<div class="menu-main-menu-container">
	<ul id="menu-main-menu-1" class="nav-menu">
	<li class="link-home menu-item menu-item-type-post_type menu-item-object-page menu-item-359"><a href="https://galeracluster.com/">Home</a></li>
	<li class="menu-item menu-item-type-post_type menu-item-object-page menu-item-has-children menu-item-35"><a href="https://galeracluster.com/products/">Products</a></li>
	<li class="menu-item menu-item-type-post_type menu-item-object-page menu-item-has-children menu-item-34"><a href="https://galeracluster.com/downloads/">Downloads</a></li>
	<li class="menu-item menu-item-type-post_type menu-item-object-page current-menu-item page_item page-item-12 current_page_item current-menu-ancestor current-menu-parent current_page_parent current_page_ancestor menu-item-has-children menu-item-33"><a href="https://galeracluster.com/support/">Support</a></li>
	<li class="menu-item menu-item-type-post_type menu-item-object-page menu-item-has-children menu-item-32"><a href="https://galeracluster.com/community/">Community</a></li>
	<li class="menu-item menu-item-type-post_type menu-item-object-page menu-item-has-children menu-item-31"><a href="https://galeracluster.com/company/">Company</a></li>
	<li class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-297"><a href="https://galeracluster.com/category/blog/">Blog</a></li>
	<li class="menu-item menu-item-type-post_type menu-item-object-page menu-item-38"><a href="https://galeracluster.com/contact-us/">Contact us</a></li>
	</ul></div>			</div><!-- .footer-menu -->


	<div class="footer-bar">
	<p class="copyright">2014 Codership Ltd.</p>
	</div>
	<div class="footnote">
	<h2>Your data is invaluable. We're here to secure it. All of it.</h2>
	</div>
	</footer><!-- #colophon -->




  </body>
</html>