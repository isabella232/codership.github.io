<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <meta content="Synchronizing a Transaction Before Executing Another" name="title" />
<meta content="en-US" name="language" />
<meta content="Codership Oy, 2014 - 2019. All Rights Reserved." name="copyright" />

    <title>Synchronizing a Transaction Before Executing Another &#8212; Galera Cluster Documentation</title>
    
    <link rel="stylesheet" href="../_static/reset-style.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../',
        VERSION:     '',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true,
        SOURCELINK_SUFFIX: '.txt'
      };
    </script>
    <script type="text/javascript" src="../_static/jquery.js"></script>
    <script type="text/javascript" src="../_static/underscore.js"></script>
    <script type="text/javascript" src="../_static/doctools.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Frequently Asked Questions" href="../faq.html" />
    <link rel="prev" title="Setting an SELinux Policy" href="setting-selinux-policy.html" />


<script type="text/javascript" src="https://www.google.com/jsapi"></script>

<meta name="viewport" content="width=device-width,initial-scale=1.0"/>
<link rel="stylesheet" href="/library/_static/basic-style.css">
<link rel="stylesheet" href="/library/_static/header.css">
<link rel="stylesheet" href="/library/_static/footer.css">
<link rel="stylesheet" href="/library/_static/codership.css">
<link rel="stylesheet" media="screen and (max-width: 500px)" href="/library/_static/mobile.css"/>
<link rel="stylesheet" media="screen and (min-width:501px) and (max-width:768px)" href="/library/_static/tablet.css"/>

<link rel="alternate" type="application/rss+xml" title="Galera Cluster for MySQL &raquo; Feed" href="https://galeracluster.com/feed/" />
<link rel="alternate" type="application/rss+xml" title="Galera Cluster for MySQL &raquo; Comments Feed" href="https://galeracluster.com/comments/feed/" />
<link rel="alternate" type="application/rss+xml" title="Galera Cluster for MySQL &raquo; Support Comments Feed" href="https://galeracluster.com/support/feed/" />

<script type='text/javascript' src='https://galeracluster.com/wp-includes/js/comment-reply.min.js?ver=3.8.3'></script>

<link rel="EditURI" type="application/rsd+xml" title="RSD" href="https://galeracluster.com/xmlrpc.php?rsd" />
<link rel="wlwmanifest" type="application/wlwmanifest+xml" href="https://galeracluster.com/wp-includes/wlwmanifest.xml" />
<link rel='prev' title='Downloads' href='https://galeracluster.com/downloads/' />
<link rel='next' title='Community' href='https://galeracluster.com/community/' />
<meta name="generator" content="WordPress 3.8.3" />

<link rel='shortlink' href='https://galeracluster.com/?p=12' />

<style type="text/css">.recentcomments a{display:inline !important;padding:0 !important;margin:0 !important;}</style>
<style type="text/css" id="twentythirteen-header-css">
			.site-title,
			.site-description {
				position: absolute;
				clip: rect(1px 1px 1px 1px); /* IE7 */
				clip: rect(1px, 1px, 1px, 1px);
			}
				.site-header .home-link {
				min-height: 0;
			}
</style>

<script type="text/javascript">

		  var _gaq = _gaq || [];
		  _gaq.push(['_setAccount', 'UA-35163478-6']);
		  _gaq.push(['_trackPageview']);

		  (function() {
			var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
			ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'https://www') + '.google-analytics.com/ga.js';
			var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
		  })();

</script>

  </head>
  <body role="document">
	<div id="fb-root"></div>
	<script>(function(d, s, id) {
		  var js, fjs = d.getElementsByTagName(s)[0];
		  if (d.getElementById(id)) return;
		  js = d.createElement(s); js.id = id;
		  js.src = "//connect.facebook.net/en_US/all.js#xfbml=1";
		  fjs.parentNode.insertBefore(js, fjs);
		}(document, 'script', 'facebook-jssdk'));
	</script>

	<div id="page" class="hfeed site">

	<header id="masthead" class="site-header" role="banner">

	<div class="top">
	<a class="home-link" href="https://galeracluster.com/" title="Galera Cluster for MySQL" rel="home">
	<h1 class="site-title">Galera Cluster for MySQL</h1>
	<h2 class="site-description">The world&#039;s most advanced open source database cluster</h2>
	</a>
	</div>


	<div id="navbar" class="navbar">
	<nav id="site-navigation" class="navigation main-navigation" role="navigation">
	<div class="menu-main-menu-container">

	<ul id="menu-main-menu" class="nav-menu">
	<li id="menu-item-359" class="link-home menu-item menu-item-type-post_type menu-item-object-page menu-item-359"><a href="https://galeracluster.com/">Home</a></li>
	<li id="menu-item-35" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-has-children menu-item-35"><a href="https://galeracluster.com/products/">Products</a></li>
	<li id="menu-item-34" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-has-children menu-item-34"><a href="https://galeracluster.com/downloads/">Downloads</a></li>
	<li id="menu-item-33" class="menu-item menu-item-type-post_type menu-item-object-page current-menu-item page_item page-item-12 current_page_item current-menu-ancestor current-menu-parent current_page_parent current_page_ancestor menu-item-has-children menu-item-33"><a href="https://galeracluster.com/support/">Support</a></li>
	<li id="menu-item-32" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-has-children menu-item-32"><a href="https://galeracluster.com/community/">Community</a></li>
	<li id="menu-item-31" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-has-children menu-item-31"><a href="https://galeracluster.com/company/">Company</a></li>
	<li id="menu-item-297" class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-297"><a href="https://galeracluster.com/category/blog/">Blog</a></li>
	<li id="menu-item-38" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-38"><a href="https://galeracluster.com/contact-us/">Contact us</a></li>
	</ul>
	</div>


	</nav><!-- #site-navigation -->

	</div><!-- #navbar -->
	</header><!-- #masthead -->


  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <div class="left-margin container">
<div class="left-margin-top container">
<a class="reference internal" href="../index.html"><span class="doc">The Library</span></a></div>
<div class="left-margin-content container">
<ul class="simple">
<li><a class="reference internal" href="../documentation/index.html"><span class="doc">Documentation</span></a></li>
</ul>
<ul class="here simple">
<li><a class="reference internal" href="index.html"><span class="doc">Knowledge Base</span></a></li>
</ul>
<ul class="simple">
<li><a class="reference internal" href="../training/index.html"><span class="doc">Training</span></a></li>
</ul>
<ul class="sub-links simple">
<li><a class="reference internal" href="../training/tutorials/index.html"><span class="doc">Tutorial Articles</span></a></li>
<li><a class="reference internal" href="../training/videos/index.html"><span class="doc">Training Videos</span></a></li>
</ul>
<ul class="simple">
<li><a class="reference internal" href="../faq.html"><span class="doc">FAQ</span></a></li>
</ul>
<p>Related Documents</p>
<ul class="simple">
<li><a class="reference internal" href="../documentation/wsrep-functions.html"><span class="doc">Galera Functions</span></a></li>
<li><a class="reference internal" href="../documentation/galera-status-variables.html#wsrep-provider-version"><span class="std std-ref">wsrep_provider_version</span></a></li>
<li><a class="reference internal" href="../documentation/wsrep-functions.html#wsrep-last-written-gtid"><span class="std std-ref">wsrep_last_written_gtid()</span></a></li>
</ul>
</div>
</div>
<div class="top-links container">
<ul class="simple">
<li><a class="reference external" href="https://galeracluster.com">Home</a></li>
<li><a class="reference internal" href="../documentation/index.html"><span class="doc">Docs</span></a></li>
</ul>
<ul class="here simple">
<li><a class="reference internal" href="index.html"><span class="doc">KB</span></a></li>
</ul>
<ul class="nav-wider simple">
<li><a class="reference internal" href="../training/index.html"><span class="doc">Training</span></a></li>
</ul>
<ul class="simple">
<li><a class="reference internal" href="../faq.html"><span class="doc">FAQ</span></a></li>
</ul>
</div>
<div class="library-article section" id="synchronizing-a-transaction-before-executing-another">
<span id="kb-best-sync-transaction-first"></span><h1>Synchronizing a Transaction Before Executing Another<a class="headerlink" href="#synchronizing-a-transaction-before-executing-another" title="Permalink to this headline">¶</a></h1>
<p class="article-stats">Length: 391 words; Published: May 30, 2019; Updated: October 22, 2019; Category: Schema &amp; SQL; Type: Best Practices</p>
<p>There are times in which a user—or an application—will perform complex tasks, to add and change data dynamically and contingent upon whatever factors might be important to the user. Along these lines, someone or an application may enter a transaction, but may not want it commited until a previous transaction has been committed.  This can be a bit tricky, especially when a cluster is using a load balancer:  The second transaction may have be sent to a different node than the first.  If that happens, the user will have difficulty being sure that the second node has already replicated the first transaction. Fortunately, there are now some Galera functions that can help.</p>
<p>Prior to version 4.0 of Galera Cluster, you could use the <a class="reference internal" href="../documentation/mysql-wsrep-options.html#wsrep-sync-wait"><span class="std std-ref">wsrep_sync_wait</span></a> session variable to wait for the node to be synchronized before executing a transaction.  It would cause the node to enable causality checks, holding any new queries until the database server is synchronized with all updates that were made prior to the start of the current transaction. While this method does ensure that the node reaches the most up-to-date state before executing a query, it also means that the node may be waiting to receive updates that might have nothing to do with a query it&#8217;s waiting to execute. If those unrealted queries are large and time consuming, the pending transaction will be significantly delayed and the apparent performce will be reduced.</p>
<p>Beginning with version 4.0 of Galera Cluster, you can use Galera functions to make transactions contingent upon a specific transaction.  The node will waits only until that transaction, based on its GTID, is applied before executing the query.</p>
<p class="section-heading rubric">Scenario</p>
<p>With the preamble above in mind, consider this scenario:  Suppose we start a transaction on one node, then we make some schema and data changes to a huge table during that transaction, and then we execute <code class="docutils literal"><span class="pre">COMMIT</span></code> to finish and commit the transaction.  As an example, imagine we have a database for a <code class="docutils literal"><span class="pre">bookstore</span></code>, with a table for <code class="docutils literal"><span class="pre">books</span></code> we sell.  That table is huge, containing millions of rows of data with many columns, including a some <code class="docutils literal"><span class="pre">BLOB</span></code> columns, and it has a few indexes. The processing will take quite a while.</p>
<p>Let&#8217;s be more specific, for this example: The <code class="docutils literal"><span class="pre">books</span></code> table contains a column for the ISBN code for each book, but it&#8217;s the older 10-digit code.  We want to convert to the new 13-digit code.  Some time ago, as a temporary work-around, we created a user function called, <code class="docutils literal"><span class="pre">CONVERT_ISBN()</span></code> that uses a <a class="reference external" href="https://en.wikipedia.org/wiki/International_Standard_Book_Number#ISBN-13_check_digit_calculation">complex formula</a> to convert from the old ISBN to the new one. That worked fine for a while, but one of our main vendors has stopped using the old ISM and will only use the new 13-digit ISBN codes. They&#8217;ve just given us a file that we want to import into our books table. So we decide to alter our <code class="docutils literal"><span class="pre">books</span></code> table to the new system and stop relying on our user function after this transaction.</p>
<p>The first transaction, to convert the <code class="docutils literal"><span class="pre">books</span></code> table, might look something like this:</p>
<div class="highlight-mysql"><div class="highlight"><pre><span></span><span class="n">START</span> <span class="n">TRANSACTION</span><span class="p">;</span>

<span class="k">ALTER</span> <span class="k">TABLE</span> <span class="n">books</span> <span class="n">DISABLE</span> <span class="k">KEYS</span><span class="p">;</span>

<span class="k">ALTER</span> <span class="k">TABLE</span> <span class="n">books</span>
<span class="k">ADD</span> <span class="k">COLUMN</span> <span class="n">isbn_10</span> <span class="kt">CHAR</span><span class="p">(</span><span class="mi">10</span><span class="p">),</span>
<span class="k">CHANGE</span> <span class="k">COLUMN</span> <span class="n">isbn</span> <span class="kt">CHAR</span><span class="p">(</span><span class="mi">14</span><span class="p">);</span>

<span class="k">UPDATE</span> <span class="n">books</span> <span class="kt">SET</span> <span class="n">isbn_10</span> <span class="o">=</span> <span class="n">isbn</span><span class="p">;</span>
<span class="k">UPDATE</span> <span class="n">books</span> <span class="kt">SET</span> <span class="n">isbn</span> <span class="o">=</span> <span class="nf">CONVERT_ISBN</span><span class="p">(</span><span class="n">isbn</span><span class="p">);</span>

<span class="k">ALTER</span> <span class="k">TABLE</span> <span class="n">books</span> <span class="n">ENABLE</span> <span class="k">KEYS</span><span class="p">;</span>

<span class="n">COMMIT</span><span class="p">;</span>
</pre></div>
</div>
<p>Let&#8217;s go through each SQL statement here. After this transaction is started, we disable the indexes so the schema changes and data updates will execute faster.  Then we execute an <code class="docutils literal"><span class="pre">ALTER</span> <span class="pre">TABLE</span></code> statement to add a column that will store the old 10-digit code (e.g., <code class="docutils literal"><span class="pre">0578041065</span></code>) as a reference, and change the current <code class="docutils literal"><span class="pre">isbn</span></code> column to allow for thirteen digits plus the one hyphen in the book code (e.g., <code class="docutils literal"><span class="pre">978-0578041063</span></code>). Once that&#8217;s done, we execute an <code class="docutils literal"><span class="pre">UPDATE</span></code> statement to copy the old ISBN to <code class="docutils literal"><span class="pre">isbn_10</span></code>, and another to convert the values in <code class="docutils literal"><span class="pre">isbn</span></code> to the new format.  We end by enabling the indexes, which will run for quite a while, and then ending the transaction with <code class="docutils literal"><span class="pre">COMMIT</span></code>.</p>
<p>Once the transaction above has been executed and committed on all nodes, we want to execute a transaction to execute the <code class="docutils literal"><span class="pre">LOAD</span> <span class="pre">DATA</span></code> statement to import the list of new books from our vendor. But we want to be sure that all of the nodes have committed the previous transaction.  We don&#8217;t want to risk that load balancer sends this transaction to a different node that has not yet changed the <code class="docutils literal"><span class="pre">isbn</span></code> column. It won&#8217;t be wide enough for the 13-digit codes, so the import will fail.  To do this, we&#8217;ll need to use one of the new Galera functions available starting in version 4.0 of Galera Cluster.</p>
<p class="section-heading rubric">Solution</p>
<p>To make a transaction contingent upon the completing of a previous transaction, we will need to get the GTID for the transaction.  Much like the MySQL function, <code class="docutils literal"><span class="pre">LAST_INSERT_ID()</span></code> will return the number inserted the <code class="docutils literal"><span class="pre">AUTO_INCREMENT</span></code> column of the table, the <a class="reference internal" href="../documentation/wsrep-functions.html#wsrep-last-written-gtid"><span class="std std-ref">WSREP_LAST_WRITTEN_GTID()</span></a> function will return the <a class="reference internal" href="../documentation/glossary.html#term-global-transaction-id"><span class="xref std std-term">Global Transaction ID</span></a> (GTID) of the transaction. So after the first transaction is committed, we would execute the following SQL statement to get the GTID:</p>
<div class="highlight-mysql"><div class="highlight"><pre><span></span><span class="kt">SET</span> <span class="o">@</span><span class="n">books_change_gtid</span> <span class="o">=</span> <span class="p">(</span><span class="k">SELECT</span> <span class="nf">WSREP_LAST_WRITTEN_GTID</span><span class="p">());</span>
</pre></div>
</div>
<p>To make it easier to use, we&#8217;ve saved the results of the <code class="docutils literal"><span class="pre">SELECT</span></code> with the <code class="docutils literal"><span class="pre">WSREP_LAST_WRITTEN_GTID(</span> <span class="pre">)</span></code> function in a user variable we created here. We can use that variable in the next transaction, which also will import the data file from our vendor:</p>
<div class="highlight-mysql"><div class="highlight"><pre><span></span><span class="n">START</span> <span class="n">TRANSACTION</span><span class="p">;</span>

<span class="k">SELECT</span> <span class="nf">WSREP_SYNC_WAIT_UPTO_GTID</span><span class="p">(</span><span class="o">@</span><span class="n">books_change_gtid</span><span class="p">);</span>

<span class="k">ALTER</span> <span class="k">TABLE</span> <span class="n">books</span> <span class="n">DISABLE</span> <span class="k">KEYS</span><span class="p">;</span>

<span class="k">LOAD</span> <span class="n">DATA</span> <span class="n">LOCAL</span> <span class="k">INFILE</span> <span class="s1">&#39;oup_books.csv&#39;</span>
<span class="k">INTO</span> <span class="k">TABLE</span> <span class="n">books</span>
<span class="n">FIELDS</span> <span class="k">TERMINATED</span> <span class="k">BY</span> <span class="s1">&#39;|&#39;</span>
<span class="k">ENCLOSED</span> <span class="k">BY</span> <span class="s1">&#39;&quot;&#39;</span>
<span class="k">LINES</span> <span class="k">TERMINATED</span> <span class="k">BY</span> <span class="s1">&#39;\r\n&#39;</span>
<span class="k">IGNORE</span> <span class="mi">1</span> <span class="k">LINES</span>
<span class="p">(</span><span class="n">isbn</span><span class="p">,</span> <span class="n">title</span><span class="p">,</span> <span class="n">author</span><span class="p">,</span> <span class="n">description</span><span class="p">,</span> <span class="n">publisher</span><span class="p">,</span> <span class="n">pub_year</span><span class="p">,</span> <span class="n">price</span><span class="p">);</span>

<span class="k">ALTER</span> <span class="k">TABLE</span> <span class="n">books</span> <span class="n">ENABLE</span> <span class="k">KEYS</span><span class="p">;</span>

<span class="n">COMMIT</span><span class="p">;</span>
</pre></div>
</div>
<p>With this function, <a class="reference internal" href="../documentation/wsrep-functions.html#wsrep-sync-wait-upto-gtid"><span class="std std-ref">WSREP_SYNC_WAIT_UPTO_GTID()</span></a> tells the node to wait until the transaction identified by the GTID given within the parentheses (the value of our user variable) is committed before processing this transaction.</p>
<div class="bottom-links container">
<p>Related Documents</p>
<ul class="simple">
<li><a class="reference internal" href="../documentation/wsrep-functions.html"><span class="doc">Galera Functions</span></a></li>
<li><a class="reference internal" href="../documentation/galera-status-variables.html#wsrep-provider-version"><span class="std std-ref">wsrep_provider_version</span></a></li>
<li><a class="reference internal" href="../documentation/wsrep-functions.html#wsrep-last-written-gtid"><span class="std std-ref">wsrep_last_written_gtid()</span></a></li>
</ul>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
            <p class="logo"><a href="../index.html">
              <img class="logo" src="../_static/logo.png" alt="Logo"/>
            </a></p><div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../index.html">Documentation overview</a><ul>
  <li><a href="index.html">The Codership Knowledge Base</a><ul>
      <li>Previous: <a href="setting-selinux-policy.html" title="previous chapter">Setting an SELinux Policy</a></li>
      <li>Next: <a href="../faq.html" title="next chapter">Frequently Asked Questions</a></li>
  </ul></li>
  </ul></li>
</ul>
</div>
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <form class="search" action="../search.html" method="get">
      <div><input type="text" name="q" /></div>
      <div><input type="submit" value="Go" /></div>
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
	<div class="navbar">
	<nav id="site-navigation" class="navigation main-navigation" role="navigation">
	<div class="nav-bar-container">

	<div id="menu-nav-bar" class="nav-menu">
		<ul class="nav-link">
			<li> </li>

		</ul>

	</div>
	</nav>

	<footer id="colophon" class="site-footer" role="contentinfo">
	<div class="top">	<div class="powered-by"><p>Powered by Galera:</p>
	<p><a href="https://mariadb.com/kb/en/galera/"><img class="alignleft size-full wp-image-237" alt="MariaDB" src="https://galeracluster.com/wp-content/uploads/2013/10/logo-mariadb.png" width="166" height="49" /></a></p>
		</div></div>
	<div class="footer-menu">
	<div class="menu-main-menu-container">
	<ul id="menu-main-menu-1" class="nav-menu">
	<li class="link-home menu-item menu-item-type-post_type menu-item-object-page menu-item-359"><a href="https://galeracluster.com/">Home</a></li>
	<li class="menu-item menu-item-type-post_type menu-item-object-page menu-item-has-children menu-item-35"><a href="https://galeracluster.com/products/">Products</a></li>
	<li class="menu-item menu-item-type-post_type menu-item-object-page menu-item-has-children menu-item-34"><a href="https://galeracluster.com/downloads/">Downloads</a></li>
	<li class="menu-item menu-item-type-post_type menu-item-object-page current-menu-item page_item page-item-12 current_page_item current-menu-ancestor current-menu-parent current_page_parent current_page_ancestor menu-item-has-children menu-item-33"><a href="https://galeracluster.com/support/">Support</a></li>
	<li class="menu-item menu-item-type-post_type menu-item-object-page menu-item-has-children menu-item-32"><a href="https://galeracluster.com/community/">Community</a></li>
	<li class="menu-item menu-item-type-post_type menu-item-object-page menu-item-has-children menu-item-31"><a href="https://galeracluster.com/company/">Company</a></li>
	<li class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-297"><a href="https://galeracluster.com/category/blog/">Blog</a></li>
	<li class="menu-item menu-item-type-post_type menu-item-object-page menu-item-38"><a href="https://galeracluster.com/contact-us/">Contact us</a></li>
	</ul></div>			</div><!-- .footer-menu -->


	<div class="footer-bar">
	<p class="copyright">2014 Codership Ltd.</p>
	</div>
	<div class="footnote">
	<h2>Your data is invaluable. We're here to secure it. All of it.</h2>
	</div>
	</footer><!-- #colophon -->




  </body>
</html>